;/*FB_PKG_DELIM*/

__d("WACryptoSha256Builder",["WABinary"],(function(a,b,c,d,e,f,g){"use strict";var h=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],i=64,j=4;a=function(){function a(){this.h0=0,this.h1=0,this.h2=0,this.h3=0,this.h4=0,this.h5=0,this.h6=0,this.h7=0,this.tail=new Uint8Array(0),this.size=0,this.reset()}var b=a.prototype;b.reset=function(){this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225,this.tail=new Uint8Array(0),this.size=0};b.update=function(a){var b=new Uint8Array(this.tail.length+a.length);b.set(this.tail);b.set(a,this.tail.length);this.size+=a.length*8;while(b.length>=i){a=b.subarray(0,i);this.$1(a);b=b.slice(i)}this.tail=b;return this};b.$2=function(){var a=new Uint8Array(64);a.set(this.tail);a.set(new Uint8Array([128]),this.tail.length);if(this.tail.length+9>i){this.$1(a);var b=p(new Uint8Array(0),this.size);this.$1(b)}else{b=p(a,this.size);this.$1(b)}};b.finish=function(){this.$2();var a=new(d("WABinary").Binary)();a.writeUint32(this.h0);a.writeUint32(this.h1);a.writeUint32(this.h2);a.writeUint32(this.h3);a.writeUint32(this.h4);a.writeUint32(this.h5);a.writeUint32(this.h6);a.writeUint32(this.h7);this.reset();return a.readByteArray()};b.$1=function(a){var b=[];for(var c=0;c<16;c++){var d=a.subarray(c*j,j*(c+1));d=d[0]<<24|d[1]<<16|d[2]<<8|d[3];b.push(d)}for(d=16;d<64;d++){a=k(b[d-15]);c=l(b[d-2]);a=b[d-16]+(b[d-7]+a+c)>>>0;b.push(a)}c=this.h0;a=this.h1;d=this.h2;var e=this.h3,f=this.h4,g=this.h5,i=this.h6,n=this.h7;for(var o=0;o<64;o++){var p=m(f,6)^m(f,11)^m(f,25),q=f&g^~f&i,r=m(c,2)^m(c,13)^m(c,22),s=c&a^c&d^a&d;p=n+p+q+h[o]+b[o];q=r+s;n=i;i=g;g=f;f=e+p>>>0;e=d;d=a;a=c;c=p+q>>>0}this.h0=this.h0+c>>>0;this.h1=this.h1+a>>>0;this.h2=this.h2+d>>>0;this.h3=this.h3+e>>>0;this.h4=this.h4+f>>>0;this.h5=this.h5+g>>>0;this.h6=this.h6+i>>>0;this.h7=this.h7+n>>>0};return a}();function k(a){var b=m(a,7),c=m(a,18);a=n(a,3);return b^c^a}function l(a){var b=m(a,17),c=m(a,19);a=n(a,10);return b^c^a}function m(a,b){return a>>>b|a<<32-b}function n(a,b){return a>>>b}function o(a){return new Uint8Array(new Uint32Array([a]).buffer)}function p(a,b){var c=new Uint8Array(i);c.set(a);a=o(b);c.set(a.subarray(0,1),c.length-1);c.set(a.subarray(1,2),c.length-2);c.set(a.subarray(2,3),c.length-3);c.set(a.subarray(3,4),c.length-4);c.set(a.subarray(4,5),c.length-5);c.set(a.subarray(5,6),c.length-6);c.set(a.subarray(6,7),c.length-7);c.set(a.subarray(7,8),c.length-8);return c}g.Sha256Builder=a;g.sigma0=k;g.sigma1=l;g.rotateRight=m;g.shiftRight=n}),98);
__d("WACryptoSha256HmacBuilder",["WACryptoSha256Builder"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a){this.$1=new(d("WACryptoSha256Builder").Sha256Builder)(),this.$2=new Uint8Array(0),this.reset(a)}var b=a.prototype;b.reset=function(a){this.$2=new Uint8Array(64);a.length>64?this.$2.set(new(d("WACryptoSha256Builder").Sha256Builder)().update(a).finish(),0):this.$2.set(a,0);a=this.$2.map(function(a){return a^54});this.$1=new(d("WACryptoSha256Builder").Sha256Builder)().update(a)};b.update=function(a){this.$1.update(a);return this};b.finish=function(){var a=this.$2.map(function(a){return a^92}),b=this.$1.finish();return new(d("WACryptoSha256Builder").Sha256Builder)().update(a).update(b).finish()};return a}();g.Sha256HMacBuilder=a}),98);
__d("WAIDBTypes",[],(function(a,b,c,d,e,f){"use strict";function a(){return indexedDB}f.idb=a}),66);
__d("Worm",["WAPREList","WAPREMetrics","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error performing ",": ",""]);h=function(){return a};return a}var i=d("WATagsLogger").TAGS(["WORM"]),j=1e4;a=function(){function a(a){this.$1=a}var c=a.prototype;c.init=function(a){return this.$1.init(a)};c.close=function(){this.$1.close()};c.runInTransaction=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){var f;f=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WORM,{bool:{isWorm:!0},string:{operationType:(f=e)!=null?f:"unknown_worm_transaction"}},void 0,j);try{a=(yield this.$1.runInTransaction(a,b,c,{eventFlow:f}));f.endSuccess();return a}catch(a){f.endFail("error");i.ERROR(h(),e,a);throw a}});function c(b,c,d,e){return a.apply(this,arguments)}return c}();return a}();g.OP_TIMEOUT_MS=j;g.WormDatabase=a}),98);
__d("WormEncoding",["msgpack-msgpack"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=new(d("msgpack-msgpack").ExtensionCodec)(),b=0;a.register({decode:function(a){a=d("msgpack-msgpack").decode(a);return a.buffer.slice(a.byteOffset,a.byteLength+a.byteOffset)},encode:function(a){if(a instanceof ArrayBuffer)return d("msgpack-msgpack").encode(new Uint8Array(a))},type:b});b=1;a.register({decode:function(a){a=d("msgpack-msgpack").decode(a);return new Uint8Array(a.buffer.slice(a.byteOffset,a.byteLength+a.byteOffset))},encode:function(a){if(a instanceof Uint8Array)return d("msgpack-msgpack").encode(a)},type:b});return{decode:function(b){return d("msgpack-msgpack").decode(b,{extensionCodec:a})},encode:function(b){return d("msgpack-msgpack").encode(b,{extensionCodec:a,ignoreUndefined:!0})}}}g.createEncoding=a}),98);
__d("WormIDbGetMinMaxKeySelector",[],(function(a,b,c,d,e,f){"use strict";a=-Infinity;var g;b=function(){if(g!=null)return g;try{IDBKeyRange.only([[]]);g=[[]];return g}catch(b){var a=String.fromCharCode(65535);g=a;return a}};f.MIN_KEY=a;f.getMaxSelector=b}),66);
__d("WormEAR",["Promise","WABinary","WACryptoDependencies","WACryptoSha256","WACryptoSha256HmacBuilder","WATagsLogger","WATimeUtils","WormEncoding","WormIDbGetMinMaxKeySelector","asyncToGeneratorRuntime","tweetnacl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error on keychain initialisation: ","; keyHashCheck:",""]);i=function(){return a};return a}var j="_encryptedContent",k=d("WATagsLogger").TAGS(["WormEAR"]),l=function(b){babelHelpers.inheritsLoose(a,b);function a(a){var c;c=b.call(this,a)||this;c.name="WormEAREncryptionError";c.message=a;return c}return a}(babelHelpers.wrapNativeSuper(Error)),m=function(b){babelHelpers.inheritsLoose(a,b);function a(a,c,d){var e;e=b.call(this,a)||this;e.name="WormEARDecryptionError";e.message=a;e.store=c;e.pk=d;return e}return a}(babelHelpers.wrapNativeSuper(Error));function n(a,b,c){if(typeof a==="number")return a;b=b.encode(a);a=new(d("WACryptoSha256HmacBuilder").Sha256HMacBuilder)(new Uint8Array(c)).update(b).finish();return a.buffer}var o=32,p=2,q=128,r=12,s=256,t=new Uint8Array(0).buffer,u="AES-GCM",v="HKDF",w="SHA-256";a=60*60;c=24*a;var x=0,y=c*30*6;e=function(){function a(a,b,c){this.$6=0;this.$8=!1;this.$9=!1;this.$1=a;this.$7=(a=c==null?void 0:c.encKeyTtl)!=null?a:y;this.$2=d("WormEncoding").createEncoding();this.$3=b;this.$5=crypto.subtle.importKey("raw",b,{name:u},!1,["encrypt","decrypt"]);this.$4=new Map()}var c=a.prototype;c.isSecureStore=function(a){return this.$1[a].secure!==!1};c.$10=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){return(yield d("WACryptoSha256").sha256Base64(this.$3)).substring(0,5)});function c(){return a.apply(this,arguments)}return c}();c.prepareNewKeyVersion=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=d("WACryptoDependencies").getCrypto(),b=a.getRandomValues(new Uint8Array(o)).buffer,c=a.getRandomValues(new Uint8Array(o)).buffer,e=a.getRandomValues(new Uint8Array(r)),f=(yield this.$5);a=(yield a.subtle.encrypt({iv:e,name:u,tagLength:q},f,c));return{clientKey:b,expiration:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+this.$7),keyHash:yield this.$10(),salt:d("WABinary").Binary.build(e,a).readBuffer()}});function c(){return a.apply(this,arguments)}return c}();c.init=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var f=this;this.$4=new Map();this.$8=c.incorrectVersions;this.$9=c.versionsLoss;var g=d("WACryptoDependencies").getCrypto(),j=(yield this.$10()),l=!0;try{yield (h||(h=b("Promise"))).all(a.map(function(a){l=l&&a.keyHash===j;var c=a.salt,d=c.slice(0,r),e=c.slice(r);return f.$5.then(function(c){return(h||(h=b("Promise"))).all([g.subtle.importKey("raw",a.clientKey,{name:v},!1,["deriveKey"]),g.subtle.decrypt({iv:new Uint8Array(d),name:u,tagLength:q},c,e)])}).then(function(a){var b=a[0];a=a[1];return g.subtle.deriveKey({hash:{name:w},info:t,name:v,salt:a},b,{length:s,name:u},!0,["encrypt","decrypt"])}).then(function(a){return g.subtle.exportKey("raw",a)}).then(function(b){f.$6=Math.max(f.$6,a.version),f.$4.set(a.version,b)})}))}catch(a){k.ERROR(i(),a,l);throw a}finally{e==null?void 0:e.eventFlow.addAnnotations({bool:{keyHashCheck:l}})}});function c(b,c,d){return a.apply(this,arguments)}return c}();c.$11=function(a){var b=this.$4.get(this.$6);if(b==null)throw new l("EAR.Encryption.Key does not exist for version");var c=d("tweetnacl").randomBytes(d("tweetnacl").secretbox.nonceLength);a=d("tweetnacl").secretbox(a,c,new Uint8Array(b));return d("WABinary").Binary.build(x,this.$6,c,a).readBuffer()};c.$12=function(a,b,c){var e=a.slice(0,p);e=new DataView(e).getUint8(1);var f=this.$4.get(e);if(f==null)throw new m("EAR.Decryption.Key does not exist for version: "+e+"; incorrectVersions: "+this.$8.toString()+" versionsLoss: "+this.$9.toString(),b,c);e=a.slice(p,p+d("tweetnacl").secretbox.nonceLength);a=a.slice(p+d("tweetnacl").secretbox.nonceLength,p+d("tweetnacl").secretbox.nonceLength+4*Math.ceil(a.byteLength/3));a=d("tweetnacl").secretbox.open(new Uint8Array(a),new Uint8Array(e),new Uint8Array(f));if(a==null)throw new m("EAR.Decryption. Unable to decrypt; incorrectVersions: "+this.$8.toString()+" versionsLoss: "+this.$9.toString(),b,c);return a};c.encryptEntity=function(a,b){b=this.$1[b];var c=new Set();b.autoIncrement!==!0&&c.add(b.primaryKey);var d=b.indexes;if(d!=null)for(var e of Object.keys(d)){var f=d[e];for(f of f.fields)c.add(f)}f={};for(e of c){f[e]=((d=b.nonEncryptedFields)==null?void 0:d.has(e))?a[e]:n(a[e],this.$2,this.$3)}b.autoIncrement===!0&&a[b.primaryKey]!=null&&(f[b.primaryKey]=a[b.primaryKey]);return babelHelpers["extends"]({},f,(c={},c[j]=this.$11(this.$2.encode(a)),c))};c.decryptEntity=function(a,b,c){return this.$2.decode(this.$12(a[j],b,c))};c.hashPk=function(a,b,c){return((a=this.$1[a].nonEncryptedFields)==null?void 0:a.has(b))?c:n(c,this.$2,this.$3)};c.hashSelector=function(a,b,c){var e;a=[].concat(a);e=(c=(e=this.$1[b].indexes)==null?void 0:(e=e[c])==null?void 0:e.fields)!=null?c:[];for(c=0;c<a.length;c++){var f,g=a[c],h=e[c];if(g===d("WormIDbGetMinMaxKeySelector").getMaxSelector())continue;if(g===-Infinity)continue;if((f=this.$1[b].nonEncryptedFields)==null?void 0:f.has(h))continue;a[c]=n(g,this.$2,this.$3)}return a};return a}();g.ENCRYPTED_COLUMN_NAME=j;g.EncryptionError=l;g.DecryptionError=m;g.WormEAR=e}),98);
__d("WormGlobalConfig",[],(function(a,b,c,d,e,f){"use strict";var g={batchReadIndex:function(){return!1}};function a(){return g}function b(a){g=a}f.getWormGlobalConfig=a;f.setWormGlobalConfig=b}),66);
__d("WormPromise",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;a=typeof self==="object"?self.Promise:typeof globalThis==="object"?globalThis.Promise:g||b("Promise");f.WormPromise=a}),66);
__d("WormStoreFunctions",["WormPromise"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){var f=[];return d("WormPromise").WormPromise.all(e.map(function(b){b=b.selector;return a.getByIndex(c,b)})).then(function(c){var g=[],h=[];c.forEach(function(a,c){c=e[c].item;if(a){var d=babelHelpers["extends"]({},c);a=a[b.primaryKey];d[b.primaryKey]=a;g.push(d);f.push(a)}else h.push(c),f.push(null)});return d("WormPromise").WormPromise.all([a.bulkPut(g),a.bulkAdd(h).then(function(a){var b=0;f.forEach(function(c,d){c==null&&(f[d]=a[b++])})})])}).then(function(){return f.filter(Boolean)})}function b(a,b,c,d){return a.readIndex(b,c,babelHelpers["extends"]({},d,{limit:1})).then(function(a){return(a=a[0])!=null?a:null})}g.bulkUpsert=a;g.getByIndex=b}),98);
__d("WormIDbStore",["Promise","WormEAR","WormGlobalConfig","WormIDbGetMinMaxKeySelector","WormPromise","WormStoreFunctions","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(){};a=function(){function a(a,b,c,d,e){this.$1=b.objectStore(a),this.$2=a,this.$3=d,this.$4=c,this.$5=e}var e=a.prototype;e.$6=function(a,b){var c=this.$4.eventFlow.isActive()?this.$4.eventFlow:null;c==null?void 0:c.addPoint(b+"_start");a=a();c==null?void 0:c.addPoint(b+"_end");return a};e.$7=function(a){if(d("WormEAR").ENCRYPTED_COLUMN_NAME in a)return{encrypted:!0,encryptedEntity:a};else return{encrypted:!1,entity:a}};e.$8=function(){return this.$3.isSecureStore(this.$2)};e.$9=function(a){var b=this;if(a==null)return a;if(!this.$8())return a;var d=this.$7(a);if(!d.encrypted)throw c("err")("Attempt to decrypt not encrypted entity");var e=a[this.$5.primaryKey];return this.$6(function(){var a=b.$3.decryptEntity(d.encryptedEntity,b.$2,e);if(b.$5.autoIncrement===!0){var c;return babelHelpers["extends"]({},a,(c={},c[b.$5.primaryKey]=e,c))}return a},"decrypt")};e.$10=function(a){var b=this;return!this.$8()?a:this.$6(function(){return b.$3.encryptEntity(a,b.$2)},"encrypt")};e.$11=function(a){var b=this;return!this.$8()?a:this.$6(function(){return b.$3.hashPk(b.$2,b.$5.primaryKey,a)},"hashPk")};e.$12=function(a,b){var c=this;if(!this.$8())return a;return a==null?a:this.$6(function(){return c.$3.hashSelector(a,c.$2,b)},"hashSelector")};e.$13=function(a){var b=this;return new(d("WormPromise").WormPromise)(function(c,d){var e=a();e.onsuccess=function(){try{c(e.result.map(function(a){return b.$9(a)}))}catch(a){d(a)}};e.onerror=function(){return d(e.error)}})};e.$14=function(a,b){var c=this;return new(d("WormPromise").WormPromise)(function(d,e){var f,g=[],h=(b==null?void 0:b.limit)!=null,i=Math.max(0,(f=b==null?void 0:b.limit)!=null?f:0);if(h&&i===0){d(g);return}var j=a();j.onsuccess=function(){var a=j.result;if(a){var f;try{f=c.$9(a.value)}catch(a){e(a);return}(!(b==null?void 0:b.filter)||b.filter(f))&&g.push(f);if(h&&i===g.length){d(g);return}a["continue"]()}else d(g)};j.onerror=function(){return e(j.error)}})};e.bulkAdd=function(a){var c=this;return(h||(h=b("Promise"))).all(a.map(function(a){return new(d("WormPromise").WormPromise)(function(b,d){var e=c.$1.add(c.$10(a));e.onsuccess=function(){c.$5.autoIncrement===!0?b(e.result):b(a[c.$5.primaryKey])};e.onerror=function(){return d(e.error)}})}))};e.bulkPut=function(a){var c=this;return(h||(h=b("Promise"))).all(a.map(function(a){return new(d("WormPromise").WormPromise)(function(b,d){var e=c.$1.put(c.$10(a));e.onsuccess=b;e.onerror=function(){return d(e.error)}})})).then(i)};e.bulkUpsert=function(a,b){return d("WormStoreFunctions").bulkUpsert(this,this.$5,a,b)};e.bulkGet=function(a){var c=this;return(h||(h=b("Promise"))).all(a.map(function(a){return new(d("WormPromise").WormPromise)(function(b,d){var e=c.$1.get(c.$11(a));e.onsuccess=function(){try{b(c.$9(e.result))}catch(a){d(a)}};e.onerror=function(){return d(e.error)}})}))};e.get=function(a){return this.bulkGet([a]).then(function(a){return a[0]})};e.getByIndex=function(a,b,c){return d("WormStoreFunctions").getByIndex(this,a,b,c)};e.readByKeyRange=function(a,b){var c=this;return a==null?this.$14(function(){return c.$1.openCursor(null,(b==null?void 0:b.order)==="desc"?"prev":"next")},b):this.$14(function(){return c.$1.openCursor(c.$15(a,c.$5.primaryKey),(b==null?void 0:b.order)==="desc"?"prev":"next")},b)};e.$16=function(a,b,e){if(this.$5.indexes==null)throw c("err")("No indexes found for store");a=this.$5.indexes[a].fields;if(b.length===a.length)return b;a=a.map(function(a,c){return(a=b[c])!=null?a:e==="max"?d("WormIDbGetMinMaxKeySelector").getMaxSelector():d("WormIDbGetMinMaxKeySelector").MIN_KEY});return a};e.$15=function(a,b){var d=b===this.$5.primaryKey;if(a.only!=null){if(this.$5.indexes==null)throw c("err")("No indexes found for store");var e=this.$5.indexes[b].fields;return a.only.length===e.length?IDBKeyRange.only(this.$12(a.only,b)):IDBKeyRange.bound(d?this.$11(a.only):this.$12(this.$16(b,a.only,"min"),b),d?this.$11(a.only):this.$12(this.$16(b,a.only,"max"),b),!0,!0)}if(a.lessThan!=null||a.lessThanOrEqual!=null){e=(e=a.lessThan)!=null?e:a.lessThanOrEqual;if(a.greaterThan!=null||a.greaterThanOrEqual!=null){var f;f=(f=a.greaterThan)!=null?f:a.greaterThanOrEqual;return IDBKeyRange.bound(d?this.$11(f):this.$12(this.$16(b,f,"min"),b),d?this.$11(e):this.$12(this.$16(b,e,"max"),b),a.greaterThan!=null,a.lessThan!=null)}return IDBKeyRange.upperBound(d?this.$11(e):this.$12(this.$16(b,e,"max"),b),a.lessThan!=null)}else{e=(f=a.greaterThan)!=null?f:a.greaterThanOrEqual;if(e!=null)return IDBKeyRange.lowerBound(d?this.$11(e):this.$12(this.$16(b,e,"min"),b),a.greaterThan!=null);else throw c("err")("Invalid range")}};e.readIndexRange=function(a,b,c){var d=this;return b==null?this.$14(function(){return d.$1.index(a).openCursor(null,(c==null?void 0:c.order)==="desc"?"prev":"next")},c):this.$14(function(){return d.$1.index(a).openCursor(d.$15(b,a),(c==null?void 0:c.order)==="desc"?"prev":"next")},c)};e.readIndex=function(a,b,c){var e=this;return(c==null?void 0:c.filter)==null&&(c==null?void 0:c.order)!=="desc"&&d("WormGlobalConfig").getWormGlobalConfig().batchReadIndex()?this.$13(function(){var d;return e.$1.index(a).getAll(e.$12(b,a),(d=c==null?void 0:c.limit)!=null?d:void 0)}):this.$14(function(){return e.$1.index(a).openCursor(e.$12(b,a),(c==null?void 0:c.order)==="desc"?"prev":"next")},c)};e.readIndexKeys=function(a,b,c){var d=this;return this.readIndex(a,b,c).then(function(a){return a.map(function(a){return a[d.$5.primaryKey]})})};e.readKeysByIndexRange=function(a,b,c){var d=this;return this.readIndexRange(a,b,c).then(function(a){return a.map(function(a){return a[d.$5.primaryKey]})})};e.readAll=function(a){var b=this;return(a==null?void 0:a.filter)===null&&(a==null?void 0:a.order)!=="desc"&&d("WormGlobalConfig").getWormGlobalConfig().batchReadIndex()?this.$13(function(){var c;return b.$1.getAll((c=a==null?void 0:a.limit)!=null?c:void 0)}):this.$14(function(){return b.$1.openCursor(null,(a==null?void 0:a.order)==="desc"?"prev":"next")},a)};e.readKeys=function(a){var b=this;return this.readAll(a).then(function(a){return a.map(function(a){return a[b.$5.primaryKey]})})};e.bulkDelete=function(a){var c=this;return(h||(h=b("Promise"))).all(a.map(function(a){return new(d("WormPromise").WormPromise)(function(b,d){var e=c.$1["delete"](c.$11(a));e.onsuccess=b;e.onerror=function(){return d(e.error)}})})).then(i)};e.clear=function(){var a=this;return new(d("WormPromise").WormPromise)(function(b,c){var d=a.$1.clear();d.onsuccess=b;d.onerror=function(){return c(d.error)}}).then(i)};e.count=function(){var a=this;return new(d("WormPromise").WormPromise)(function(b,c){var d=a.$1.count();d.onsuccess=function(){return b(d.result)};d.onerror=function(){return c(d.error)}})};return a}();g.WormIDbStore=a}),98);
__d("WormIDbTransaction",["WAResolvable","WormIDbStore"],(function(a,b,c,d,e,f,g){"use strict";var h=function(b){babelHelpers.inheritsLoose(a,b);function a(){var a,c="WormUnknownError";a=b.call(this,c)||this;a.name=c;a.message=c;return a}return a}(babelHelpers.wrapNativeSuper(Error)),i=function(b){babelHelpers.inheritsLoose(a,b);function a(){var a,c="WormUnknownAbortError";a=b.call(this,c)||this;a.name=c;a.message=c;return a}return a}(babelHelpers.wrapNativeSuper(Error));a=function(){function a(a,b,c,e,f){var g=this;this.$1=a;this.$2=new(d("WAResolvable").Resolvable)();this.$1.oncomplete=function(){g.$2.resolve()};this.$1.onerror=function(a){var b;b=(a=(b=g.$1.error)!=null?b:(b=a.target)==null?void 0:b.error)!=null?a:new h();g.$2.reject(b)};this.$1.onabort=function(a){var b;b=(a=(b=g.$1.error)!=null?b:(b=a.target)==null?void 0:b.error)!=null?a:new i();g.$2.reject(b)};this.$3=e.reduce(function(a,e){return babelHelpers["extends"]({},a,(a={},a[e]=new(d("WormIDbStore").WormIDbStore)(e,g.$1,b,c,f[e]),a))},(a=this.$3)!=null?a:{})}var b=a.prototype;b.commit=function(){return this.$2.promise};b.abort=function(){this.$2.isSettled||this.$1.abort()};babelHelpers.createClass(a,[{key:"stores",get:function(){return this.$3}}]);return a}();g.WormIDbTransaction=a}),98);
__d("WormIDbTypes",[],(function(a,b,c,d,e,f){"use strict";a="_worm_db_version_";b="_worm_ear_";c="schema_hash";f.DB_VERSION_STORE=a;f.EAR_STORE=b;f.SCHEMA_HASH_KEY=c}),66);
__d("WormIDbUtils",["Promise","WAIDBTypes","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return new(h||(h=b("Promise")))(function(b,c){a.onsuccess=function(){return b(a.result)},a.onerror=function(){return c(a.error)}})}function e(a,e,f){var g=e.onBecomeStale,i=e.onClose,j=e.onError,k=e.onUpgrade;return new(h||(h=b("Promise")))(function(b,e){var h=d("WAIDBTypes").idb().open(a,f);k!=null&&(h.onupgradeneeded=function(){if(h.transaction==null)throw c("err")("Transaction is null on upgradeneeded event");k(h.result,h.transaction)});h.onsuccess=function(){var a=h.result;i!=null&&(a.onclose=i);a.onversionchange=function(){a.close(),g!=null&&g()};b(a)};h.onerror=function(){e(h.error),j!=null&&j(h.error)}})}g.promisifyIDbRequest=a;g.openIDb=e}),98);
__d("WormIDbUpgrade",["WormIDbTypes","WormIDbUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){var d=[],e=[],f=new Map(),g=Array.from(Object.keys(c)).map(function(a){return a.toString()});g=new Set(g);for(var h of Object.keys(c))if(!a.objectStoreNames.contains(h))d.push(h);else{if(c[h].secure!==!1)continue;var i=c[h];i=(i=i.indexes)!=null?i:{};var j=b.objectStore(h),k=j.indexNames,l=new Set(Object.keys(i)),m=[],n=[];for(var o of l)!k.contains(o)?m.push(o):j.index(o).unique!==i[o].unique&&(m.push(o),n.push(o));for(j=0;j<k.length;j++){o=k[j];l.has(o)||n.push(o)}(m.length>0||n.length>0)&&f.set(h,{indexesToCreate:m,indexesToDelete:n})}for(i=0;i<a.objectStoreNames.length;i++){o=a.objectStoreNames[i];g.has(o)||e.push(o)}return{storesToCreate:d,storesToDelete:e,storesToModify:f}}function a(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){if(!a.objectStoreNames.contains(d("WormIDbTypes").DB_VERSION_STORE))return{isNewDb:!0,shouldUpgrade:!0};a=a.transaction(d("WormIDbTypes").DB_VERSION_STORE,"readonly");a=(yield d("WormIDbUtils").promisifyIDbRequest(a.objectStore(d("WormIDbTypes").DB_VERSION_STORE).get(d("WormIDbTypes").SCHEMA_HASH_KEY)));return{isNewDb:!1,shouldUpgrade:(a==null?void 0:a.value)!==b}});return i.apply(this,arguments)}function j(a,b,c){for(c of c){var d=b[c],e=a.createObjectStore(c,{autoIncrement:!!d.autoIncrement,keyPath:d.primaryKey});d=d.indexes;if(d==null)continue;for(var f of Object.keys(d)){var g=d[f];e.createIndex(f,g.fields.map(function(a){return a.toString()}),{unique:g.unique})}}}function c(a,b,c,e,f){var g=h(a,b,c),i=g.storesToCreate,k=g.storesToDelete;g=g.storesToModify;j(a,c,i);for(i of k)f.has(i)&&a.deleteObjectStore(i);for(k of g){a=k[0];f=k[1];i=f.indexesToCreate;g=f.indexesToDelete;for(f of g)b.objectStore(a).deleteIndex(f);g=c[a].indexes;if(g==null)continue;for(f of i){i=g[f];b.objectStore(a).createIndex(f,i.fields,{unique:i.unique})}}b.objectStore(d("WormIDbTypes").DB_VERSION_STORE).put({key:d("WormIDbTypes").SCHEMA_HASH_KEY,value:e})}g.shouldUpgradeDb=a;g.createNewStores=j;g.upgradeDb=c}),98);
__d("WormIDbDriver",["Promise","WABridge","WACryptoSha256","WAOdsEnums","WAResolvable","WATagsLogger","WATimeUtils","WormIDbTransaction","WormIDbTypes","WormIDbUpgrade","WormIDbUtils","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["EAR initialization error: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unrecoverable error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected error: ",""]);k=function(){return a};return a}var l=d("WATagsLogger").TAGS(["WormIDbDriver"]),m={_worm_db_version_:{primaryKey:"key",secure:!1},_worm_ear_:{primaryKey:"version",secure:!1}};a=function(){function a(a,b,c,e){this.$4=null;this.$7=[];this.$11=function(){d("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.WORM,key:"error.db_stale"})};this.$12=function(){d("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.WORM,key:"error.db_close"})};this.$13=function(a){l.ERROR(k(),a)};this.$2=a;this.$3=b;this.$5=(a=e==null?void 0:e.safeToDeleteStores)!=null?a:new Set();this.$8=e==null?void 0:e.blockingErrorThreshold;this.$9=(b=e==null?void 0:e.onBlockingError)!=null?b:function(){};this.$10=(a=e==null?void 0:e.onTransactionError)!=null?a:function(){};this.$6=c}var e=a.prototype;e.$14=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){this.$4!=null&&(yield this.$4.promise);if(this.$1==null)throw c("err")("IDB is not initialised");b=new(d("WormIDbTransaction").WormIDbTransaction)(this.$1.transaction(a.map(function(a){return a.toString()}),b,{durability:"relaxed"}),f,this.$6,a,this.$3);f=(yield e(b));yield b.commit();return f});function e(b,c,d,e){return a.apply(this,arguments)}return e}();e.$15=function(a){var b;if(this.$8==null)return;var c=this.$8;a=(b=(b=(b=a==null?void 0:a.name)!=null?b:a==null?void 0:a.message)!=null?b:a==null?void 0:a.toString())!=null?b:"unknown";this.$7.push(a);if(this.$7.length<Math.max(c,1))return;var d=this.$7[this.$7.length-1];b=this.$7.every(function(a){return a===d})?d:"mixed";l.ERROR(j(),b);this.$9(b);this.$7=[]};e.$16=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,d){this.$1==null&&(d.eventFlow.addPoint("db_reinit_start",{bool:{isDbNull:!0}}),yield this.$17(),d.eventFlow.addPoint("db_reinit_end"));var e;try{e=(yield this.$14(a,b,c,d))}catch(f){if((f==null?void 0:f.name)==="InvalidStateError")d.eventFlow.addPoint("db_reinit_start",{bool:{isDbInvalid:!0}}),yield this.$17(),d.eventFlow.addPoint("db_reinit_end"),e=(yield this.$14(a,b,c,d));else throw f}return e});function c(b,c,d,e){return a.apply(this,arguments)}return c}();e.runInTransaction=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,d){var e;try{e=(yield this.$16(a,b,c,d)),this.$7=[]}catch(a){this.$10(a);this.$15(a);throw a}return e});function c(b,c,d,e){return a.apply(this,arguments)}return c}();e.close=function(){var a;(a=this.$1)==null?void 0:a.close()};e.init=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{yield this.$17(a)}catch(a){if((a==null?void 0:a.name)==="InvalidStateError")yield this.$17();else throw a}});function c(b){return a.apply(this,arguments)}return c}();e.$17=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=this,e=!1;if(this.$4){e=!0;return this.$4.promise}this.$4=new(d("WAResolvable").Resolvable)();var f=!1;this.$1!=null&&(this.$1.close(),this.$1=null,f=!0);var g=!0;try{var h=babelHelpers["extends"]({},this.$3,m),j=JSON.stringify(h);if(j==null)throw c("err")("DB schema cannot be serialized");var k=(yield d("WACryptoSha256").sha256Str(j));j=(yield d("WormIDbUtils").openIDb(this.$2,{onBecomeStale:this.$11,onClose:this.$12,onError:this.$13}));var n=(yield d("WormIDbUpgrade").shouldUpgradeDb(j,k));g=n.shouldUpgrade;if(!g)this.$1=j;else{var o=j.version;j.close();this.$1=(yield d("WormIDbUtils").openIDb(this.$2,{onBecomeStale:this.$11,onClose:this.$12,onError:this.$13,onUpgrade:function(a,c){return d("WormIDbUpgrade").upgradeDb(a,c,h,k,b.$5)}},o+1))}a==null?void 0:a.eventFlow.addPoint("ear_init_start");try{yield this.$18(n.isNewDb,a)}catch(b){a==null?void 0:a.eventFlow.addPoint("ear_init_err");l.ERROR(i(),b);throw b}a==null?void 0:a.eventFlow.addPoint("ear_init_end");(j=this.$4)==null?void 0:j.resolve()}catch(a){(o=this.$4)==null?void 0:o.reject(a);throw a}finally{a==null?void 0:a.eventFlow.addAnnotations({bool:{isClosingDb:f,isCompetingInit:e,shouldUpgrade:g}}),this.$4=null}});function e(b){return a.apply(this,arguments)}return e}();e.$18=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var f=this,g=(yield this.$6.prepareNewKeyVersion()),i=!1,j=!1,k=(yield new(h||(h=b("Promise")))(function(b,e){if(f.$1==null)throw c("err")("IDB is not initialised");var h=[],k=f.$1.transaction(d("WormIDbTypes").EAR_STORE,"readwrite");k.oncomplete=function(){return b(h)};k.onerror=k.onabort=function(){return e(k.error)};var l=k.objectStore(d("WormIDbTypes").EAR_STORE),m=l.getAll();m.onsuccess=function(){var c;c=(c=m.result)!=null?c:[];h=c.filter(n);i=c.length!==h.length;h.sort(function(a,b){return a.version-b.version});c=h.length===0||!d("WATimeUtils").isInFuture(h[h.length-1].expiration);if(!c){b(h);return}c=h.length===0?0:h[h.length-1].version;j=!a&&c===0;c=babelHelpers["extends"]({},g,{version:c+1});l.add(c);h.push(c)};m.onerror=function(){return e(m.error)}}));yield this.$6.init(k,{incorrectVersions:i,versionsLoss:j},e)});function e(b,c){return a.apply(this,arguments)}return e}();return a}();function n(a){if(a==null)return!1;if(a.version==null)return!1;if(a.expiration==null)return!1;if(a.clientKey==null||a.clientKey.byteLength===0)return!1;return a.salt==null||a.salt.byteLength===0?!1:!0}g.sysSchema=m;g.WormIDbDriver=a}),98);
__d("getProtocolMsgIdByMsgIdCommon",["MAWDexieTable","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("MAWDexieTable").dexieAll([a.messages.get({msgId:b}),a.unrenderedMessages.get({msgId:b}),a.reactions.get({reactionId:b})]).then(function(b){var c=b[0],e=b[1];b=b[2];if(b!=null)if(d("WAJids").isAuthorSystem(b.author))return null;else return{author:b.author,chat:b.threadJid,externalId:b.externalId};var f=c||e;return f==null?null:a.threads.get({jid:f.threadJid}).then(function(a){if(a==null)return null;return d("WAJids").isAuthorSystem(f.author)?null:{author:f.author,chat:a.jid,externalId:f.externalId}})})}g.getProtocolMsgIdByMsgIdCommon=a}),98);