;/*FB_PKG_DELIM*/

__d("LSIsValidEpochAnonIdFlow",[],(function(a,b,c,d,e,f){"use strict";var g=11;function a(a){if(a.byteLength>g)return!1;a=new Int8Array(a);var b=0;for(var c=0;c<a.length;c++)b|=+(a[c]<48),b|=+(a[c]>57);return b===0}f.call=a}),66);
__d("LSIsValidEpochAnonId.nop",["LSIsValidEpochAnonIdFlow","LSResult","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a,e,f){return(h||(h=b("Promise"))).resolve(c("LSResult")(d("LSIsValidEpochAnonIdFlow").call(f)))};g["default"]=a}),98);
__d("LSAddDeviceWithVirtualDeviceAndDecryptionKey",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Decode.nop","LSBase64Encode.nop","LSCreateAuthKeyPair.nop","LSCreateDebugToken.nop","LSCreateDerivedKeys.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignatureWithArmadilloKey.nop","LSCreateSignature_v2.nop","LSDeleteBackupOnClient","LSGetArmadilloPublicKey.nop","LSGetBlobFromString.nop","LSHandleWrongRecoveryCode","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIsValidEpochAnonId.nop","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop","LSPublicEncryptionCreateDecryptedData.nop","LSSymmetricEncryptionCreateDecryptedString.nop","justknobx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(f){return d.sequence([function(f){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] Beginning execution."),d.filter(d.db.table(168).fetch(),function(a){return d.i64.eq(a.authorityLevel,d.i64.cast([0,80]))}).next().then(function(f,g){g=f.done;f=f.value;return g?d.sequence([function(a){return d.db.table(168).fetch().next().then(function(a,c){var e=a.done;a=a.value;return e?0:(c=a.item,d.storedProcedure(b("LSDeleteBackupOnClient"),c.backupId,void 0,!1,void 0,"null",!0))})},function(c){return e[8]=a[3].get("encrypted_ocmf_client_state"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),e[8]).then(function(a){return a=a,e[9]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[9]).then(function(a){return a=a,e[10]=a[0],a})},function(c){return d.blobs.neq(e[10],void 0)?d.resolve(e[11]=e[10]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[8]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[11]=e[41]}])},function(c){return e[12]=a[3].get("encrypted_oblivious_validation_token_blob"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),e[12]).then(function(a){return a=a,e[13]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[13]).then(function(a){return a=a,e[14]=a[0],a})},function(c){return d.blobs.neq(e[14],void 0)?d.resolve(e[15]=e[14]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[12]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[15]=e[41]}])},function(c){return e[16]=a[3].get("encrypted_epoch_anon_id"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),e[16]).then(function(a){return a=a,e[17]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[17]).then(function(a){return a=a,e[18]=a[0],a})},function(c){return d.blobs.neq(e[18],void 0)?d.resolve(e[19]=e[18]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[16]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[19]=e[41]}])},function(a){return d.blobs.neq(e[19],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSIsValidEpochAnonId.nop"),e[19]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return e[20]=e[40]}]):d.resolve(e[20]=!1)},function(c){return e[20]?e[21]=e[19]:e[21]=void 0,e[22]=a[3].get("encrypted_epoch_root_key"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),e[22]).then(function(a){return a=a,e[23]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[23]).then(function(a){return a=a,e[24]=a[0],a})},function(c){return d.blobs.neq(e[24],void 0)?d.resolve(e[25]=e[24]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[22]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[25]=e[41]}])},function(c){return e[26]=a[3].get("encrypted_mailbox_root_key_blob"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),e[26]).then(function(a){return a=a,e[27]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[27]).then(function(a){return a=a,e[28]=a[0],a})},function(c){return d.blobs.neq(e[28],void 0)?d.resolve(e[29]=e[28]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[26]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[29]=e[41]}])},function(c){return e[30]=a[3].get("encrypted_epoch_storage_private_key"),e[30]!==void 0?d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),e[30]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(c){return d.blobs.neq(e[41],void 0)?d.resolve(e[42]=e[41]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[30]).then(function(a){return a=a,e[43]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[43]).then(function(a){return a=a,e[44]=a[0],a})},function(a){return e[42]=e[44]}])},function(a){return e[31]=e[42]}]):d.resolve(e[31]=void 0)},function(a){return d.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,e[32]=a[0],e[33]=a[1],a})},function(a){return d.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,e[34]=a[0],e[35]=a[1],a})},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[32],d.blob("MA=="),e[35]).then(function(a){return a=a,e[36]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateAuthKeyPair.nop")).then(function(a){return a=a,e[37]=a[0],e[38]=a[1],a})},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[32],d.blob("MQ=="),e[38]).then(function(a){return a=a,e[39]=a[0],a})},function(f){return d.blobs.neq(e[11],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),e[11]).then(function(a){return a=a,e[40]=a[0],e[41]=a[1],a})},function(a){return d.blobs.neq(void 0,void 0)?d.sequence([function(a){return d.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),void 0).then(function(a){return a=a,e[46]=a[0],e[47]=a[1],a})},function(a){return a=[e[40],e[41],e[46],e[47]],e[42]=a[0],e[43]=a[1],e[44]=a[2],e[45]=a[3],a}]):d.resolve((a=[e[40],e[41],void 0,void 0],e[42]=a[0],e[43]=a[1],e[44]=a[2],e[45]=a[3],a))},function(f){return d.blobs.neq(e[21],void 0)?d.blobs.neq(e[25],void 0)?d.blobs.neq(e[15],void 0)?d.blobs.neq(e[29],void 0)?d.sequence([function(a){return e[46]=d.createArray(),d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,0])).then(function(a){return a=a,e[47]=a[0],a})},function(a){return e[47]?e[60]=(e[46].push(d.i64.cast([0,0])),e[46]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,2])).then(function(a){return a=a,e[48]=a[0],a})},function(a){return e[48]?e[60]=(e[46].push(d.i64.cast([0,2])),e[46]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,3])).then(function(a){return a=a,e[49]=a[0],a})},function(a){return e[49]?e[60]=(e[46].push(d.i64.cast([0,3])),e[46]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,4])).then(function(a){return a=a,e[50]=a[0],a})},function(a){return e[50]?e[60]=(e[46].push(d.i64.cast([0,4])),e[46]):0,e[51]="",e[52]=d.i64.of_int32(e[46].length),d.i64.gt(e[52],d.i64.cast([0,0]))?d.loopAsync(e[52],function(a){return e[60]=a,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[46],e[60]).then(function(a){return a=a,e[61]=a[0],e[62]=a[1],a})},function(a){return e[51]=[e[51],"_",d.i64.to_string(e[61])].join("")}])}):d.resolve()},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),["supported_versions_",e[51],"revision_version_",d.i64.to_string(d.i64.cast([0,1]))].join("")).then(function(a){return a=a,e[53]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[32],d.blob("Mg=="),e[53]).then(function(a){return a=a,e[54]=a[0],a})},function(a){return d.blobs.neq(e[54],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[54]).then(function(a){return a=a,e[60]=a[0],a})},function(a){return e[55]=e[60]}]):d.resolve(e[55]=void 0)},function(a){return d.forEach(d.db.table(168).fetch(),function(a){return a["delete"]()})},function(a){return d.forEach(d.db.table(169).fetch(),function(a){return a["delete"]()})},function(b){return d.forEach(d.filter(d.db.table(168).fetch([[[a[1]]]]),function(b){return d.i64.eq(b.backupId,a[1])&&d.i64.lt(b.authorityLevel,d.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(b){return d.db.table(168).add({backupId:a[1],devicePublicKeyBlob:e[33],devicePrivateKeyBlob:e[32],epochStoragePublicKeyBlob:e[35],epochStoragePrivateKeyBlob:e[34],epochAuthPublicKeyBlob:e[38],epochAuthPrivateKeyBlob:e[37],mailboxRootKeyBlob:e[29],ocmfClientStateBlob:e[42],obliviousValidationTokenBlob:e[15],encryptionVersion:d.i64.cast([0,0]),revisionVersion:d.i64.cast([0,1]),authorityLevel:d.i64.cast([0,20]),backupTenancy:a[7]})},function(b){return d.forEach(d.filter(d.db.table(169).fetch([[[a[2]]]]),function(b){return d.i64.eq(b.epochId,a[2])&&d.i64.lt(b.authorityLevel,d.i64.cast([0,80]))}),function(a){return a["delete"]()})},function(b){return d.db.table(169).add({epochId:a[2],authorityLevel:d.i64.cast([0,80]),backupId:a[1],epochAnonIdBlob:e[21],epochRootKeyBlob:e[25],epochStatus:d.i64.cast([0,1])})},function(f){return e[56]=a[5].keys(),e[57]=d.i64.of_int32(e[56].length),d.i64.eq(e[57],d.i64.cast([0,1]))?(e[60]=a[5].has(d.i64.to_string(a[2])),e[60]?d.resolve(0):(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] sync_epochs does not contain base epoch"),e[61]=d.createArray(),void 0!==void 0?e[62]=(e[61].push(void 0),e[61]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","sync_epochs does not contain base epoch",e[61],d.i64.cast([0,3])))):d.sequence([function(a){return function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] Triggering epoch derivation."),e[60]=c("justknobx")._("1310"),void 0!==void 0?e[60]?d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,2866]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[61]=a[0],a})},function(a){return e[61]?e[62]=!0:e[62]=!1,e[62]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[63]=d.createArray(),void 0!==void 0?e[64]=(e[63].push(void 0),e[63]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",e[63],d.i64.cast([0,3]))):d.resolve()}]):d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,2867]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[61]=a[0],a})},function(a){return e[61]?e[62]=!0:e[62]=!1,e[62]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[63]=d.createArray(),void 0!==void 0?e[64]=(e[63].push(void 0),e[63]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",e[63],d.i64.cast([0,3]))):d.resolve()}]):d.resolve()},function(c){return e[60]===!1?function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] Epoch rotation is disabled for the user but received more than one epoch."):0,d.blobs.neq(e[31],void 0)?d.sequence([function(a){return e[64]="Starting epoch derivation at base epoch of anon id (base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[21]).then(function(a){return a=a,e[61]=a[0],a})},function(a){return e[65]=e[61]==null?"":e[61],e[62]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[62],e[64],e[62],e[65]].join("")),d.resolve()},function(c){return e[63]=a[5].get(d.i64.to_string(a[2])),e[63]!==void 0?d.sequence([function(b){return e[66]=e[63].get("is_active_epoch"),e[66]?e[67]=d.i64.cast([0,1]):e[67]=d.i64.cast([0,2]),d.forEach(d.db.table(169).fetch([[[a[2]]]]),function(a){var b=a.update;a.item;return b({authorityLevel:d.i64.cast([0,80]),epochStatus:e[67]})})},function(c){return e[68]=new d.Map(),e[68].set("epoch_id",a[2]),e[68].set("authority_level",d.i64.cast([0,80])),e[68].set("backup_id",a[1]),e[68].set("epoch_anon_id_blob",e[21]),e[68].set("epoch_root_key_blob",e[25]),e[68].set("epoch_status",d.i64.cast([0,1])),e[69]=e[68],e[70]=a[5].keys(),e[71]=d.i64.of_int32(e[70].length),d.i64.gt(e[71],d.i64.cast([0,0]))?d.loopAsync(e[71],function(c){return e[76]=c,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[70],e[76]).then(function(a){return a=a,e[77]=a[0],e[78]=a[1],a})},function(c){return e[79]=e[69].get("epoch_id"),e[80]=e[69].get("backup_id"),e[81]=e[69].get("epoch_anon_id_blob"),e[82]=e[69].get("epoch_root_key_blob"),e[83]=e[69].get("epoch_status"),e[84]=e[69].get("authority_level"),e[85]=a[5].get(d.i64.to_string(e[79])),e[85]!==void 0?d.sequence([function(c){return e[93]=e[85].get("next_epoch_id"),d.i64.neq(e[93],void 0)?d.sequence([function(c){return e[100]=a[5].get(d.i64.to_string(e[93])),e[100]!==void 0?d.sequence([function(a){return e[107]=e[100].get("backup_id"),e[108]=e[100].get("is_active_epoch"),e[108]?e[109]=d.i64.cast([0,1]):e[109]=d.i64.cast([0,2]),e[110]=e[100].get("epoch_anon_id"),e[111]=d.createArray(),e[127]=(e[111].push(d.i64.cast([0,32])),e[111]),e[127]=(e[111].push(d.i64.cast([0,32])),e[111]),e[112]="_",d.nativeOperation(b("LSGetBlobFromString.nop"),["epoch_chaining",e[112],d.blobs.to_string(e[81]),e[112],d.i64.to_string(e[79])].join("")).then(function(a){return a=a,e[113]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),e[113],void 0,e[82],e[111]).then(function(a){return a=a,e[114]=a[0],a})},function(a){return e[114]?e[115]=!1:e[115]=!0,e[115]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] Failed to generate epoch_chaining_key and epoch_distribution_pre_shared_key."),e[127]=d.createArray(),void 0!==void 0?e[130]=(e[127].push(void 0),e[127]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils","Failed to generate epoch_chaining_key and epoch_distribution_pre_shared_key.",e[127],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[128]=a[0],a})},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[129]=a[0],a})},function(a){return a=[e[128],e[129]],e[116]=a[0],e[117]=a[1],a}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[114],d.i64.cast([0,0])).then(function(a){return a=a,e[127]=a[0],e[128]=a[1],a})},function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[114],d.i64.cast([0,1])).then(function(a){return a=a,e[129]=a[0],e[130]=a[1],a})},function(a){return a=[e[127],e[129]],e[116]=a[0],e[117]=a[1],a}])},function(c){return e[118]=e[100].get("encrypted_epoch_key"),d.blobs.neq(e[118],void 0)?d.sequence([function(c){return e[127]=e[100].get("epoch_auth_public_key"),e[128]=e[100].get("epoch_anon_id"),d.nativeOperation(b("LSPublicEncryptionCreateDecryptedData.nop"),a[6],e[31],e[127],e[117],d.blobs.of_string(["epoch_","_",d.blobs.to_string(e[128])].join("")),e[118]).then(function(a){return a=a,e[129]=a[0],a})},function(a){return d.blobs.neq(e[129],void 0)?d.resolve(e[130]=e[129]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] Couldn't decrypt epoch key. Returning null entropy"),e[131]=d.createArray(),void 0!==void 0?e[132]=(e[131].push(void 0),e[131]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils","Couldn't decrypt epoch key. Returning null entropy",e[131],d.i64.cast([0,3]))},function(a){return e[130]=void 0}])},function(a){return e[119]=e[130]}]):d.sequence([function(a){return e[130]="encrypted_epoch_key is null. Can't generate epoch entropy. epoch_anon_id(base64) = ",e[127]=e[100].get("epoch_anon_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[127]).then(function(a){return a=a,e[128]=a[0],a})},function(a){return e[131]=e[128]==null?"":e[128],e[129]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[129],e[130],e[129],e[131]].join("")),e[132]=d.createArray(),void 0!==void 0?e[133]=(e[132].push(void 0),e[132]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[130],",",e[131]].join(""),e[132],d.i64.cast([0,3]))},function(a){return e[119]=void 0}])},function(a){return d.blobs.neq(e[119],void 0)?d.sequence([function(a){return e[127]=d.createArray(),e[132]=(e[127].push(d.i64.cast([0,32])),e[127]),d.nativeOperation(b("LSGetBlobFromString.nop"),"epoch_root_key").then(function(a){return a=a,e[128]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),e[128],e[116],e[119],e[127]).then(function(a){return a=a,e[129]=a[0],a})},function(a){return e[129]?e[130]=!1:e[130]=!0,e[130]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] Unable to generate epoch root key."),e[132]=d.createArray(),void 0!==void 0?e[134]=(e[132].push(void 0),e[132]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils","Unable to generate epoch root key.",e[132],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[133]=a[0],a})},function(a){return e[131]=e[133]}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[129],d.i64.cast([0,0])).then(function(a){return a=a,e[132]=a[0],e[133]=a[1],a})},function(a){return e[131]=e[132]}])},function(a){return e[120]=e[131]}]):d.sequence([function(a){return e[130]="epoch entropy is null. Can't generate epoch root key. epoch_anon_id(base64) = ",e[127]=e[100].get("epoch_anon_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[127]).then(function(a){return a=a,e[128]=a[0],a})},function(a){return e[131]=e[128]==null?"":e[128],e[129]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[129],e[130],e[129],e[131]].join("")),e[132]=d.createArray(),void 0!==void 0?e[133]=(e[132].push(void 0),e[132]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[130],",",e[131]].join(""),e[132],d.i64.cast([0,3]))},function(a){return e[120]=void 0}])},function(a){return d.blobs.neq(e[120],void 0)?d.sequence([function(a){return d.filter(d.db.table(169).fetch([[[e[93]]]]),function(a){return d.i64.eq(a.epochId,e[93])&&d.i64.gt(a.authorityLevel,d.i64.cast([0,80]))}).next().then(function(a){var b=a.done;a.value;return b?d.db.table(169).put({epochId:e[93],backupId:e[107],epochAnonIdBlob:e[110],epochRootKeyBlob:e[120],epochStatus:e[109],authorityLevel:d.i64.cast([0,80])}):0})},function(a){return a=[e[93],e[107],e[110],e[120],e[109],d.i64.cast([0,80])],e[121]=a[0],e[122]=a[1],e[123]=a[2],e[124]=a[3],e[125]=a[4],e[126]=a[5],a}]):d.sequence([function(a){return e[130]="Epoch root key is null. Can't write the epoch to the table. epoch_anon_id(base64) = ",e[127]=e[100].get("epoch_anon_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[127]).then(function(a){return a=a,e[128]=a[0],a})},function(a){return e[131]=e[128]==null?"":e[128],e[129]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[129],e[130],e[129],e[131]].join("")),e[132]=d.createArray(),void 0!==void 0?e[133]=(e[132].push(void 0),e[132]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[130],",",e[131]].join(""),e[132],d.i64.cast([0,3]))},function(a){return a=[e[79],e[80],e[81],e[82],e[83],e[84]],e[121]=a[0],e[122]=a[1],e[123]=a[2],e[124]=a[3],e[125]=a[4],e[126]=a[5],a}])},function(a){return a=[e[121],e[122],e[123],e[124],e[125],e[126]],e[101]=a[0],e[102]=a[1],e[103]=a[2],e[104]=a[3],e[105]=a[4],e[106]=a[5],a}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Unexpected error! New epoch is null even though we have a new_epoch_id value"),e[107]=d.createArray(),void 0!==void 0?e[108]=(e[107].push(void 0),e[107]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils","Unexpected error! New epoch is null even though we have a new_epoch_id value",e[107],d.i64.cast([0,3]))},function(a){return a=[e[79],e[80],e[81],e[82],e[83],e[84]],e[101]=a[0],e[102]=a[1],e[103]=a[2],e[104]=a[3],e[105]=a[4],e[106]=a[5],a}])},function(a){return a=[e[101],e[102],e[103],e[104],e[105],e[106]],e[94]=a[0],e[95]=a[1],e[96]=a[2],e[97]=a[3],e[98]=a[4],e[99]=a[5],a}]):d.sequence([function(a){return e[102]="New epoch is null. This is expected if epoch_id is the root or last epoch. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[81]).then(function(a){return a=a,e[100]=a[0],a})},function(a){return e[103]=e[100]==null?"":e[100],e[104]=" , is_forward = ",e[105]="1",e[101]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[101],e[102],e[101],e[103],e[101],e[104],e[101],e[105]].join("")),d.resolve()},function(a){return a=[e[79],e[80],e[81],e[82],e[83],e[84]],e[94]=a[0],e[95]=a[1],e[96]=a[2],e[97]=a[3],e[98]=a[4],e[99]=a[5],a}])},function(a){return a=[e[94],e[95],e[96],e[97],e[98],e[99]],e[86]=a[0],e[87]=a[1],e[88]=a[2],e[89]=a[3],e[90]=a[4],e[91]=a[5],a}]):d.sequence([function(a){return e[95]="Unexpected error! server epoch is null even though we have epoch_id. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[81]).then(function(a){return a=a,e[93]=a[0],a})},function(a){return e[96]=e[93]==null?"":e[93],e[94]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[94],e[95],e[94],e[96]].join("")),e[97]=d.createArray(),void 0!==void 0?e[98]=(e[97].push(void 0),e[97]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[95],",",e[96]].join(""),e[97],d.i64.cast([0,3]))},function(a){return a=[e[79],e[80],e[81],e[82],e[83],e[84]],e[86]=a[0],e[87]=a[1],e[88]=a[2],e[89]=a[3],e[90]=a[4],e[91]=a[5],a}])},function(a){return e[92]=new d.Map(),e[92].set("epoch_id",e[86]),e[92].set("backup_id",e[87]),e[92].set("epoch_anon_id_blob",e[88]),e[92].set("epoch_root_key_blob",e[89]),e[92].set("epoch_status",e[90]),e[92].set("authority_level",e[91]),e[69]=e[92]}])}):d.resolve()},function(a){return d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,1438]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[76]=a[0],a})},function(a){return e[76]?e[77]=!0:e[77]=!1,e[77]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[78]=d.createArray(),void 0!==void 0?e[79]=(e[78].push(void 0),e[78]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",e[78],d.i64.cast([0,3]))):d.resolve()}])},function(c){return e[72]=new d.Map(),e[72].set("epoch_id",a[2]),e[72].set("authority_level",d.i64.cast([0,80])),e[72].set("backup_id",a[1]),e[72].set("epoch_anon_id_blob",e[21]),e[72].set("epoch_root_key_blob",e[25]),e[72].set("epoch_status",d.i64.cast([0,1])),e[73]=e[72],e[74]=a[5].keys(),e[75]=d.i64.of_int32(e[74].length),d.i64.gt(e[75],d.i64.cast([0,0]))?d.loopAsync(e[75],function(c){return e[76]=c,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[74],e[76]).then(function(a){return a=a,e[77]=a[0],e[78]=a[1],a})},function(c){return e[79]=e[73].get("epoch_id"),e[80]=e[73].get("backup_id"),e[81]=e[73].get("epoch_anon_id_blob"),e[82]=e[73].get("epoch_root_key_blob"),e[83]=e[73].get("epoch_status"),e[84]=e[73].get("authority_level"),e[85]=a[5].get(d.i64.to_string(e[79])),e[85]!==void 0?d.sequence([function(c){return e[93]=e[85].get("prev_epoch_id"),d.i64.neq(e[93],void 0)?d.sequence([function(c){return e[100]=a[5].get(d.i64.to_string(e[93])),e[100]!==void 0?d.sequence([function(a){return e[107]=e[100].get("backup_id"),e[108]=e[100].get("is_active_epoch"),e[108]?e[109]=d.i64.cast([0,1]):e[109]=d.i64.cast([0,2]),e[110]=e[85].get("epoch_data_v2"),e[110]!==void 0?d.sequence([function(a){return e[117]=d.createArray(),e[135]=(e[117].push(d.i64.cast([0,32])),e[117]),d.nativeOperation(b("LSBase64Encode.nop"),e[81]).then(function(a){return a=a,e[118]=a[0],a})},function(a){return e[118]!==void 0?d.sequence([function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blobs.of_string(["epoch_data_storage","_",e[118]].join("")),void 0,e[82],e[117]).then(function(a){return a=a,e[135]=a[0],a})},function(a){return e[135]?e[136]=!1:e[136]=!0,e[136]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),e[138]=d.createArray(),void 0!==void 0?e[140]=(e[138].push(void 0),e[138]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils","THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",e[138],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[139]=a[0],a})},function(a){return e[137]=e[139]}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[135],d.i64.cast([0,0])).then(function(a){return a=a,e[138]=a[0],e[139]=a[1],a})},function(a){return e[137]=e[138]}])},function(a){return e[119]=e[137]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),e[135]=d.createArray(),void 0!==void 0?e[137]=(e[135].push(void 0),e[135]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils","THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",e[135],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[136]=a[0],a})},function(a){return e[119]=e[136]}])},function(a){return e[120]=e[110].get("epoch_anon_id"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),e[119],d.blob("ZXBvY2hfZGF0YV9tZXRhZGF0YQ=="),e[120]).then(function(a){return a=a,e[121]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[121]).then(function(a){return a=a,e[122]=a[0],a})},function(a){return d.blobs.neq(e[122],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSIsValidEpochAnonId.nop"),e[122]).then(function(a){return a=a,e[135]=a[0],a})},function(a){return e[123]=e[135]}]):d.resolve(e[123]=!1)},function(a){return e[123]?e[124]=e[122]:e[124]=void 0,e[125]=e[110].get("epoch_root_key"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),e[119],d.blob("ZXBvY2hfZGF0YV9tZXRhZGF0YQ=="),e[125]).then(function(a){return a=a,e[126]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[126]).then(function(a){return a=a,e[127]=a[0],a})},function(a){return d.blobs.neq(e[124],void 0)?d.sequence([function(a){return d.blobs.neq(e[127],void 0)?d.resolve((e[136]=new d.Map(),e[136].set("epoch_anon_id",e[124]),e[136].set("epoch_root_key",e[127]),e[135]=e[136])):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Error while decrypting epoch_root_key. Returning null"),e[136]=d.createArray(),void 0!==void 0?e[137]=(e[136].push(void 0),e[136]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils","Error while decrypting epoch_root_key. Returning null",e[136],d.i64.cast([0,3]))},function(a){return e[135]=void 0}])},function(a){return e[128]=e[135]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Error while decrypting epoch_anon_id. Returning null"),e[135]=d.createArray(),void 0!==void 0?e[136]=(e[135].push(void 0),e[135]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils","Error while decrypting epoch_anon_id. Returning null",e[135],d.i64.cast([0,3]))},function(a){return e[128]=void 0}])},function(a){return e[128]!==void 0?d.sequence([function(a){return e[135]=e[128].get("epoch_anon_id"),e[136]=e[128].get("epoch_root_key"),d.filter(d.db.table(169).fetch([[[e[93]]]]),function(a){return d.i64.eq(a.epochId,e[93])&&d.i64.gt(a.authorityLevel,d.i64.cast([0,80]))}).next().then(function(a){var b=a.done;a.value;return b?d.db.table(169).put({epochId:e[93],backupId:e[107],epochAnonIdBlob:e[135],epochRootKeyBlob:e[136],epochStatus:e[109],authorityLevel:d.i64.cast([0,80])}):0})},function(a){return a=[e[93],e[107],e[135],e[136],e[109],d.i64.cast([0,80])],e[129]=a[0],e[130]=a[1],e[131]=a[2],e[132]=a[3],e[133]=a[4],e[134]=a[5],a}]):d.sequence([function(a){return e[137]="Error while decrypting epoch data of epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[81]).then(function(a){return a=a,e[135]=a[0],a})},function(a){return e[138]=e[135]==null?"":e[135],e[136]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[136],e[137],e[136],e[138]].join("")),e[139]=d.createArray(),void 0!==void 0?e[140]=(e[139].push(void 0),e[139]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[137],",",e[138]].join(""),e[139],d.i64.cast([0,3]))},function(a){return a=[e[79],e[80],e[81],e[82],e[83],e[84]],e[129]=a[0],e[130]=a[1],e[131]=a[2],e[132]=a[3],e[133]=a[4],e[134]=a[5],a}])},function(a){return a=[e[129],e[130],e[131],e[132],e[133],e[134]],e[111]=a[0],e[112]=a[1],e[113]=a[2],e[114]=a[3],e[115]=a[4],e[116]=a[5],a}]):d.sequence([function(a){return e[119]="Error while reading epoch_data_v2. This is expected if this is the root epoch. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[81]).then(function(a){return a=a,e[117]=a[0],a})},function(a){return e[120]=e[117]==null?"":e[117],e[118]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[118],e[119],e[118],e[120]].join("")),d.resolve()},function(a){return a=[e[79],e[80],e[81],e[82],e[83],e[84]],e[111]=a[0],e[112]=a[1],e[113]=a[2],e[114]=a[3],e[115]=a[4],e[116]=a[5],a}])},function(a){return a=[e[111],e[112],e[113],e[114],e[115],e[116]],e[101]=a[0],e[102]=a[1],e[103]=a[2],e[104]=a[3],e[105]=a[4],e[106]=a[5],a}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Unexpected error! New epoch is null even though we have a new_epoch_id value"),e[107]=d.createArray(),void 0!==void 0?e[108]=(e[107].push(void 0),e[107]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils","Unexpected error! New epoch is null even though we have a new_epoch_id value",e[107],d.i64.cast([0,3]))},function(a){return a=[e[79],e[80],e[81],e[82],e[83],e[84]],e[101]=a[0],e[102]=a[1],e[103]=a[2],e[104]=a[3],e[105]=a[4],e[106]=a[5],a}])},function(a){return a=[e[101],e[102],e[103],e[104],e[105],e[106]],e[94]=a[0],e[95]=a[1],e[96]=a[2],e[97]=a[3],e[98]=a[4],e[99]=a[5],a}]):d.sequence([function(a){return e[102]="New epoch is null. This is expected if epoch_id is the root or last epoch. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[81]).then(function(a){return a=a,e[100]=a[0],a})},function(a){return e[103]=e[100]==null?"":e[100],e[104]=" , is_forward = ",e[105]="0",e[101]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[101],e[102],e[101],e[103],e[101],e[104],e[101],e[105]].join("")),d.resolve()},function(a){return a=[e[79],e[80],e[81],e[82],e[83],e[84]],e[94]=a[0],e[95]=a[1],e[96]=a[2],e[97]=a[3],e[98]=a[4],e[99]=a[5],a}])},function(a){return a=[e[94],e[95],e[96],e[97],e[98],e[99]],e[86]=a[0],e[87]=a[1],e[88]=a[2],e[89]=a[3],e[90]=a[4],e[91]=a[5],a}]):d.sequence([function(a){return e[95]="Unexpected error! server epoch is null even though we have epoch_id. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[81]).then(function(a){return a=a,e[93]=a[0],a})},function(a){return e[96]=e[93]==null?"":e[93],e[94]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[94],e[95],e[94],e[96]].join("")),e[97]=d.createArray(),void 0!==void 0?e[98]=(e[97].push(void 0),e[97]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[95],",",e[96]].join(""),e[97],d.i64.cast([0,3]))},function(a){return a=[e[79],e[80],e[81],e[82],e[83],e[84]],e[86]=a[0],e[87]=a[1],e[88]=a[2],e[89]=a[3],e[90]=a[4],e[91]=a[5],a}])},function(a){return e[92]=new d.Map(),e[92].set("epoch_id",e[86]),e[92].set("backup_id",e[87]),e[92].set("epoch_anon_id_blob",e[88]),e[92].set("epoch_root_key_blob",e[89]),e[92].set("epoch_status",e[90]),e[92].set("authority_level",e[91]),e[73]=e[92]}])}):d.resolve()},function(a){return d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,1439]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[76]=a[0],a})},function(a){return e[76]?e[77]=!0:e[77]=!1,e[77]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[78]=d.createArray(),void 0!==void 0?e[79]=(e[78].push(void 0),e[78]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",e[78],d.i64.cast([0,3]))):d.resolve()}])}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Unexpected Error. A base epoch exists on client but not found on server"),void 0!==void 0?d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,85]),d.i64.cast([0,2]),"[EncryptedBackups][MEBEpochDerivationUtils] Unexpected Error. A base epoch exists on client but not found on server",void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[67]=a[0],a})},function(a){return e[67]?e[68]=!0:e[68]=!1,e[68]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[69]=d.createArray(),void 0!==void 0?e[70]=(e[69].push(void 0),e[69]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",e[69],d.i64.cast([0,3]))):d.resolve()}]):d.resolve()},function(a){return e[66]=d.createArray(),void 0!==void 0?e[67]=(e[66].push(void 0),e[66]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils","Unexpected Error. A base epoch exists on client but not found on server",e[66],d.i64.cast([0,3]))}])}]):(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch storage private key is null"),e[61]=d.createArray(),void 0!==void 0?e[62]=(e[61].push(void 0),e[61]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","epoch storage private key is null",e[61],d.i64.cast([0,3])))}])},function(b){return d.db.table(169).fetch([[[a[4]]]]).next().then(function(b,c){var f=b.done;b=b.value;return f?(function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] No epochs keys found."),e[58]=void 0):(c=b.item,e[60]=new d.Map(),e[60].set("epoch_root_key",c.epochRootKeyBlob),e[60].set("epoch_anon_id",c.epochAnonIdBlob),e[60].set("epoch_id",a[4]),e[58]=e[60])})},function(c){return e[58]!==void 0?d.sequence([function(a){return e[60]=e[58].get("epoch_anon_id"),e[61]=e[58].get("epoch_root_key"),e[62]=d.createArray(),e[68]=(e[62].push(d.i64.cast([0,32])),e[62]),d.nativeOperation(b("LSBase64Encode.nop"),e[60]).then(function(a){return a=a,e[63]=a[0],a})},function(a){return e[63]!==void 0?d.sequence([function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blobs.of_string(["epoch_devices","_",e[63]].join("")),void 0,e[61],e[62]).then(function(a){return a=a,e[68]=a[0],a})},function(a){return e[68]?e[69]=!1:e[69]=!0,e[69]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),e[71]=d.createArray(),void 0!==void 0?e[73]=(e[71].push(void 0),e[71]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils","THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",e[71],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[72]=a[0],a})},function(a){return e[70]=e[72]}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[68],d.i64.cast([0,0])).then(function(a){return a=a,e[71]=a[0],e[72]=a[1],a})},function(a){return e[70]=e[71]}])},function(a){return e[64]=e[70]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),e[68]=d.createArray(),void 0!==void 0?e[70]=(e[68].push(void 0),e[68]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils","THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",e[68],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[69]=a[0],a})},function(a){return e[64]=e[69]}])},function(a){return d.nativeOperation(b("LSHmac_v2.nop"),e[64],e[33]).then(function(a){return a=a,e[65]=a[0],a})},function(a){return e[66]=e[58].get("epoch_root_key"),d.blobs.neq(e[66],void 0)?d.sequence([function(a){return e[68]=d.createArray(),e[74]=(e[68].push(d.i64.cast([0,18])),e[68]),d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,e[66],e[68]).then(function(a){return a=a,e[69]=a[0],a})},function(a){return e[69]!==void 0?d.sequence([function(a){return e[74]=d.i64.of_int32(e[69].length),d.i64.ge(e[74],d.i64.cast([0,1]))?d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[69],d.i64.cast([0,0])).then(function(a){return a=a,e[76]=a[0],e[77]=a[1],a})},function(a){return e[75]=e[76]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),e[76]=d.createArray(),void 0!==void 0?e[77]=(e[76].push(void 0),e[76]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",e[76],d.i64.cast([0,3]))},function(a){return e[75]=void 0}])},function(a){return e[70]=e[75]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),e[74]=d.createArray(),void 0!==void 0?e[75]=(e[74].push(void 0),e[74]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",e[74],d.i64.cast([0,3]))},function(a){return e[70]=void 0}])},function(a){return d.blobs.neq(e[70],void 0)?e[71]=!0:e[71]=!1,e[71]?0:(function(a){d.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),d["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d.nativeOperation(b("LSBase64Encode.nop"),e[70]).then(function(a){return a=a,e[72]=a[0],a})},function(a){return e[72]!==void 0?e[73]=e[72]:e[73]="encodingfailed",e[67]=e[73]}]):d.resolve(e[67]="null")},function(c){return d.blobs.neq(e[65],void 0)?d.sequence([function(a){return e[68]=e[58].get("epoch_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[33]).then(function(a){return a=a,e[69]=a[0],a})},function(a){return e[87]=e[69]==null?"":e[69],d.nativeOperation(b("LSBase64Encode.nop"),e[65]).then(function(a){return a=a,e[70]=a[0],a})},function(a){return e[86]=e[70]==null?"":e[70],d.nativeOperation(b("LSBase64Encode.nop"),e[35]).then(function(a){return a=a,e[71]=a[0],a})},function(a){return e[88]=e[71]==null?"":e[71],d.nativeOperation(b("LSBase64Encode.nop"),e[36]==null?d.blob("bnVsbA=="):e[36]).then(function(a){return a=a,e[72]=a[0],a})},function(a){return e[89]=e[72]==null?"":e[72],d.nativeOperation(b("LSBase64Encode.nop"),e[38]).then(function(a){return a=a,e[73]=a[0],a})},function(a){return e[90]=e[73]==null?"":e[73],d.nativeOperation(b("LSBase64Encode.nop"),e[39]==null?d.blob("bnVsbA=="):e[39]).then(function(a){return a=a,e[74]=a[0],a})},function(a){return e[91]=e[74]==null?"":e[74],d.nativeOperation(b("LSBase64Encode.nop"),e[43]).then(function(a){return a=a,e[75]=a[0],a})},function(c){return e[92]=e[75]==null?"":e[75],d.nativeOperation(b("LSBase64Encode.nop"),a[10]).then(function(a){return a=a,e[76]=a[0],a})},function(a){return e[93]=e[76]==null?"":e[76],d.blobs.neq(e[29],void 0)?d.sequence([function(a){return e[94]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[29],"private_key",e[32],d.i64.cast([0,1]),e[94]).then(function(a){return a=a,e[95]=a[0],a})},function(a){return d.blobs.neq(e[95],void 0)?e[96]=e[95]:e[96]=void 0,e[77]=e[96]}]):d.resolve(e[77]=void 0)},function(a){return d.blobs.neq(e[77],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[77]).then(function(a){return a=a,e[94]=a[0],a})},function(a){return e[78]=e[94]}]):d.resolve(e[78]=void 0)},function(a){return d.blobs.neq(e[29],void 0)?d.sequence([function(a){return e[94]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[29],"ocmf_client_state",e[42],d.i64.cast([0,1]),e[94]).then(function(a){return a=a,e[95]=a[0],a})},function(a){return d.blobs.neq(e[95],void 0)?e[96]=e[95]:e[96]=void 0,e[79]=e[96]}]):d.resolve(e[79]=void 0)},function(a){return d.blobs.neq(e[79],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[79]).then(function(a){return a=a,e[94]=a[0],a})},function(a){return e[80]=e[94]}]):d.resolve(e[80]=void 0)},function(a){return d.blobs.neq(e[29],void 0)?d.sequence([function(a){return e[94]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[29],"epoch_storage_private_key",e[34],d.i64.cast([0,1]),e[94]).then(function(a){return a=a,e[95]=a[0],a})},function(a){return d.blobs.neq(e[95],void 0)?e[96]=e[95]:e[96]=void 0,e[81]=e[96]}]):d.resolve(e[81]=void 0)},function(a){return d.blobs.neq(e[81],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[81]).then(function(a){return a=a,e[94]=a[0],a})},function(a){return e[82]=e[94]}]):d.resolve(e[82]=void 0)},function(c){return e[83]=new d.Map(),e[83].set("supported_encryption_versions",e[46]),e[83].set("client_version",d.i64.cast([0,1])),e[83].set("version_sig",e[55]==null?"":e[55]),d.i64.eq(a[7],d.i64.cast([0,2]))?d.resolve(e[84]=void 0):d.sequence([function(a){return d.nativeOperation(b("LSGetArmadilloPublicKey.nop")).then(function(a){return a=a,e[94]=a[0],a})},function(a){return e[84]=e[94]}])},function(a){return d.blobs.neq(e[84],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSCreateSignatureWithArmadilloKey.nop"),e[33]).then(function(a){return a=a,e[94]=a[0],a})},function(a){return d.blobs.neq(e[94],void 0)?d.resolve(e[95]=e[94]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create labyrinth signature"),e[99]=d.createArray(),void 0!==void 0?e[100]=(e[99].push(void 0),e[99]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils","Failed to create labyrinth signature",e[99],d.i64.cast([0,3]))},function(a){return e[95]=void 0}])},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[32],d.blob("Mw=="),e[84]).then(function(a){return a=a,e[96]=a[0],a})},function(a){return d.blobs.neq(e[96],void 0)?d.resolve(e[97]=e[96]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create armadillo signature"),e[99]=d.createArray(),void 0!==void 0?e[100]=(e[99].push(void 0),e[99]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils","Failed to create armadillo signature",e[99],d.i64.cast([0,3]))},function(a){return e[97]=void 0}])},function(a){return d.blobs.neq(e[97],void 0)?(d.blobs.neq(e[95],void 0)?(e[100]=new d.Map(),e[100].set("armadillo_public_key",e[84]),e[100].set("armadillo_key_signature",e[97]),e[100].set("labyrinth_key_signature",e[95]),e[99]=e[100]):e[99]=void 0,e[98]=e[99]):e[98]=void 0,e[85]=e[98]}]):d.resolve(e[85]=void 0)},function(c){return e[85]!==void 0?d.sequence([function(a){return e[94]=e[85].get("armadillo_public_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[94]).then(function(a){return a=a,e[95]=a[0],a})},function(a){return e[96]=e[85].get("armadillo_key_signature"),d.nativeOperation(b("LSBase64Encode.nop"),e[96]).then(function(a){return a=a,e[97]=a[0],a})},function(a){return e[98]=e[85].get("labyrinth_key_signature"),d.nativeOperation(b("LSBase64Encode.nop"),e[98]).then(function(a){return a=a,e[99]=a[0],a})},function(c){return e[104]=d.i64.cast([0,1e3]),e[100]=e[104],e[101]=new d.Map(),e[101].set("backup_id",a[1]),e[101].set("device_epoch_hmac",e[86]),e[101].set("epoch_root_key_fingerprint",e[67]),e[101].set("device_public_key",e[87]),e[101].set("epoch_storage_pubkey",e[88]),e[101].set("epoch_storage_pubkey_sig",e[89]),e[101].set("epoch_auth_pubkey",e[90]),e[101].set("epoch_auth_pubkey_sig",e[91]),e[101].set("ocmf_rotation_token",e[92]),e[101].set("virtual_device_id",e[93]),e[101].set("device_registration_id",a[11]),e[101].set("base_epoch_id",e[68]),e[101].set("encryption_version_data",e[83]),e[101].set("private_key_debug_token",e[78]),e[101].set("ocmf_client_state_debug_token",e[80]),e[101].set("epoch_storage_pvtkey_debug_token",e[82]),e[101].set("trace_id",a[8]),e[101].set("occam_only_eligible",!0),e[101].set("armadillo_public_key",e[95]==null?"":e[95]),e[101].set("armadillo_key_signature",e[97]==null?"":e[97]),e[101].set("labyrinth_key_signature",e[99]==null?"":e[99]),e[102]=d.toJSON(e[101]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50006]),e[102],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,e[100]).then(function(a){return a=a,e[103]=a[0],a})}]):(function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] failed to get armadillo key and device signatures"),e[98]=d.i64.cast([0,1e3]),e[94]=e[98],e[95]=new d.Map(),e[95].set("backup_id",a[1]),e[95].set("device_epoch_hmac",e[86]),e[95].set("epoch_root_key_fingerprint",e[67]),e[95].set("device_public_key",e[87]),e[95].set("epoch_storage_pubkey",e[88]),e[95].set("epoch_storage_pubkey_sig",e[89]),e[95].set("epoch_auth_pubkey",e[90]),e[95].set("epoch_auth_pubkey_sig",e[91]),e[95].set("ocmf_rotation_token",e[92]),e[95].set("virtual_device_id",e[93]),e[95].set("device_registration_id",a[11]),e[95].set("base_epoch_id",e[68]),e[95].set("encryption_version_data",e[83]),e[95].set("private_key_debug_token",e[78]),e[95].set("ocmf_client_state_debug_token",e[80]),e[95].set("epoch_storage_pvtkey_debug_token",e[82]),e[95].set("trace_id",a[8]),e[95].set("occam_only_eligible",!0),e[96]=d.toJSON(e[95]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50006]),e[96],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,e[94]).then(function(a){return a=a,e[97]=a[0],a}))}]):d.sequence([function(a){return d.db.table(178).put({pk:d.i64.cast([0,1]),recoveryCodeStatus:d.i64.cast([0,4])})},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $device_epoch_hmac found to be null"),e[68]=d.createArray(),void 0!==void 0?e[69]=(e[68].push(void 0),e[68]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","$device_epoch_hmac found to be null",e[68],d.i64.cast([0,3]))}])}]):d.sequence([function(a){return d.db.table(178).put({pk:d.i64.cast([0,1]),recoveryCodeStatus:d.i64.cast([0,4])})},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $latest_epoch_data is null."),e[60]=d.createArray(),void 0!==void 0?e[61]=(e[60].push(void 0),e[60]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","$latest_epoch_data is null.",e[60],d.i64.cast([0,3]))}])}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $mailbox root key is null"),e[46]=d.createArray(),void 0!==void 0?e[47]=(e[46].push(void 0),e[46]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","$mailbox root key is null",e[46],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $mailbox root key is null",!1)}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] oblivious validation token is null"),e[46]=d.createArray(),void 0!==void 0?e[47]=(e[46].push(void 0),e[46]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","oblivious validation token is null",e[46],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] oblivious validation token is null",!1)}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch root key is null"),e[46]=d.createArray(),void 0!==void 0?e[47]=(e[46].push(void 0),e[46]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","epoch root key is null",e[46],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch root key is null",!1)}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch anon id is null"),e[46]=d.createArray(),void 0!==void 0?e[47]=(e[46].push(void 0),e[46]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","epoch anon id is null",e[46],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch anon id is null",!1)}])}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] orf client state v1 is null"),e[40]=d.createArray(),void 0!==void 0?e[41]=(e[40].push(void 0),e[40]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","orf client state v1 is null",e[40],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] orf client state v1 is null",!1)}])}]):(f.item,function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] An authoritative row already exists, aborting execution of addDeviceFromVirtualDevice"),d.db.table(178).put({pk:d.i64.cast([0,1]),recoveryCodeStatus:d.i64.cast([0,2])}))})},function(a){return e[2]=d.i64.of_float(Date.now()),e[3]=d.i64.random(),e[5]="Finishing execution. Execution time: ",e[6]=d.i64.to_string(d.i64.sub(e[2],e[0])),e[7]=" ms",e[4]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ",e[4],e[5],e[4],e[6],e[4],e[7]].join("")),d.i64.eq(d.i64.mod_(e[3],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[8]=",",e[9]=d.createArray(),void 0!==void 0?e[10]=(e[9].push(void 0),e[9]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",[e[5],e[8],e[6],e[8],e[7]].join(""),e[9],d.i64.cast([0,4]))):d.resolve()}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_recovery_code_status","secure_encrypted_backups_epochs"];d=a;g["default"]=d}),98);
__d("LSAddDeviceFromVirtualDevice",["LSAddDeviceWithVirtualDeviceAndDecryptionKey","LSDeleteBackupOnClient","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceFromVirtualDeviceStoredProcedure] Beginning execution."),c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(e,f){f=e.done;e=e.value;return f?c.db.table(179).fetch([[[a[0]]]]).next().then(function(e,f){var g=e.done;e=e.value;return g?c.sequence([function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,4])})},function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceFromVirtualDeviceStoredProcedure] Request context for the passed task_id was not found"),d[9]=c.createArray(),void 0!==void 0?d[10]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceFromVirtualDeviceStoredProcedure","Request context for the passed task_id was not found",d[9],c.i64.cast([0,3]))},function(a){return c.db.table(168).fetch().next().then(function(d,e){var a=d.done;d=d.value;return a?0:(e=d.item,c.storedProcedure(b("LSDeleteBackupOnClient"),e.backupId,"backup_init_flow",!1,void 0,"Request context for the passed task_id was not found",!1))})}]):(f=e.item,c.sequence([function(a){return c.db.table(168).fetch().next().then(function(d,e){var a=d.done;d=d.value;return a?0:(e=d.item,c.storedProcedure(b("LSDeleteBackupOnClient"),e.backupId,void 0,!1,void 0,"null",!0))})},function(d){return c.db.table(185).fetch([[[c.i64.cast([0,1])]]]).next().then(function(e,h){var d=e.done;e=e.value;return d?c.sequence([function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,4])})},function(a){return c.db.table(168).fetch().next().then(function(d,e){var a=d.done;d=d.value;return a?0:(e=d.item,c.storedProcedure(b("LSDeleteBackupOnClient"),e.backupId,"backup_init_flow",!1,void 0,"null",!1))})}]):(h=e.item,c.storedProcedure(b("LSAddDeviceWithVirtualDeviceAndDecryptionKey"),a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],f.blobDecryptionKey,f.virtualDeviceId,h.deviceRegistrationId))})}]))}):(e.item,function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceFromVirtualDeviceStoredProcedure] An authoritative row already exists, aborting execution of addDeviceFromVirtualDevice"),c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,2])}))})},function(a){return d[2]=c.i64.of_float(Date.now()),d[3]=c.i64.random(),d[5]="Finishing execution. Execution time: ",d[6]=c.i64.to_string(c.i64.sub(d[2],d[0])),d[7]=" ms",d[4]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceFromVirtualDeviceStoredProcedure] ",d[4],d[5],d[4],d[6],d[4],d[7]].join("")),c.i64.eq(c.i64.mod_(d[3],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[8]=",",d[9]=c.createArray(),void 0!==void 0?d[10]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceFromVirtualDeviceStoredProcedure",[d[5],d[8],d[6],d[8],d[7]].join(""),d[9],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsAddDeviceFromVirtualDeviceStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_recovery_code_status","secure_recovery_code_data","device_metadata"];e.exports=a}),null);