;/*FB_PKG_DELIM*/

__d("LSHandleAddDeviceSuccess",["LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure] Beginning execution."),c.filter(c.db.table(168).fetch([[[a[0]]]]),function(b){return c.i64.eq(b.backupId,a[0])&&c.blobs.eq(b.devicePublicKeyBlob,a[2])}).next().then(function(e,f){f=e.done;e=e.value;return f?c.sequence([function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,4])})},function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure] backup client state is empty"),d[8]=c.createArray(),void 0!==void 0?d[9]=(d[8].push(void 0),d[8]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure","backup client state is empty",d[8],c.i64.cast([0,3]))}]):(e.item,c.sequence([function(b){return c.forEach(c.db.table(168).fetch([[[a[0]]]]),function(b){var d=b.update;b.item;return d({deviceId:a[1],authorityLevel:c.i64.cast([0,80])})})},function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,2])})},function(b){return c.forEach(c.db.table(169).fetch([[[a[0]]],"fk_secure_encrypted_backups_client_state"]),function(a){var b=a.update;a.item;return b({authorityLevel:c.i64.cast([0,80])})})}]))})},function(a){return d[2]=c.i64.of_float(Date.now()),d[3]=c.i64.random(),d[5]="Finishing execution. Execution time: ",d[6]=c.i64.to_string(c.i64.sub(d[2],d[0])),d[7]=" ms",d[4]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure] ",d[4],d[5],d[4],d[6],d[4],d[7]].join("")),c.i64.eq(c.i64.mod_(d[3],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[8]=",",d[9]=c.createArray(),void 0!==void 0?d[10]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure",[d[5],d[8],d[6],d[8],d[7]].join(""),d[9],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_recovery_code_status","secure_encrypted_backups_epochs"];e.exports=a}),null);