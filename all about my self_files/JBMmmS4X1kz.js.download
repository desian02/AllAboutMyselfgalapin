;/*FB_PKG_DELIM*/

__d("LSCreateRecoveryCode.nop",["CryptoLogger","GF32RecoveryCodes","GaloisField32","LSResult","Promise","UInt8Array"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){while(!0){var b=d("UInt8Array").getBufferWithRandomValuesFromLength(1);b=new Uint8Array(b)[0];if(b<256-256%a)return b%a;continue}return 0}a=function(a,e){a=["2","0"].join("");try{e=[];for(var f=0;f<=33;++f)e.push(i(32));f=d("GF32RecoveryCodes").getEccForCode(d("GaloisField32").asGf32MatExn(e));e=e.concat(f);f=d("GaloisField32").matrixToSymbols(d("GaloisField32").asGf32MatExn(e));e=a+f;return(h||(h=b("Promise"))).resolve(c("LSResult")(e))}catch(a){d("CryptoLogger").captureError(d("CryptoLogger").CryptoLogger("create_recovery_code"),a).mustfix("creating recovery code failed");throw a}};g["default"]=a}),98);
__d("LSEncryptedBackupsCreateVirtualDeviceActionType",[],(function(a,b,c,d,e,f){a=Object.freeze({INSERT:1,UNIQUE_VD_TYPE_INSERT:2});f["default"]=a}),66);
__d("LSGenerateRecoveryCode",["LSCreateRecoveryCode.nop","LSGetViewerFBID","LSLogMebClientEvent.nop","LSParseRecoveryCode_v2.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateRecoveryCodeStoredProcedure] Beginning execution."),c.forEach(c.filter(c.db.table(174).fetch(),function(a){return a.recoveryCode==="1SHADOWTESTINGRECOVERYCODE00000000000000"}),function(a){return a["delete"]()})},function(a){return c.db.table(174).fetch([[[c.i64.cast([0,1])]]]).next().then(function(a,e){var f=a.done;a=a.value;return f?c.sequence([function(a){return c.nativeOperation(b("LSCreateRecoveryCode.nop")).then(function(a){return a=a,d[15]=a[0],a})},function(a){return c.db.table(174).add({pk:c.i64.cast([0,1]),recoveryCode:d[15]})},function(a){return d[1]=d[15]}]):(e=a.item,d[1]=e.recoveryCode)})},function(b){return c.forEach(c.db.table(174).fetch([[[c.i64.cast([0,1])]]]),function(b){var c=b.update;b.item;return c({virtualDeviceType:a[0],cloudServiceAccount:void 0,hsmPinNormalizationStatus:void 0})})},function(a){return d[3]=c.createArray(),c.db.table(172).fetch().next().then(function(a,b){var e=a.done;a=a.value;return e?d[4]=void 0:(b=a.item,d[16]=b.encryptionManagementDelegatorId,c.i64.neq(d[16],void 0)?(c.i64.neq(d[16],c.i64.cast([0,0]))?d[17]=c.i64.to_string(d[16]):d[17]=void 0,d[15]=d[17]):d[15]=void 0,d[4]=d[15])})},function(a){return c.storedProcedure(b("LSGetViewerFBID")).then(function(a){return a=a,d[6]=a[0],a})},function(a){return c.nativeOperation(b("LSParseRecoveryCode_v2.nop"),d[1],d[4]==null?c.i64.to_string(d[6]):d[4],d[3]).then(function(a){return a=a,d[7]=a[0],d[8]=a[1],a})},function(a){return d[9]=c.i64.of_float(Date.now()),d[10]=c.i64.random(),d[12]="Finishing execution. Execution time: ",d[13]=c.i64.to_string(c.i64.sub(d[9],d[0])),d[14]=" ms",d[11]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateRecoveryCodeStoredProcedure] ",d[11],d[12],d[11],d[13],d[11],d[14]].join("")),c.i64.eq(c.i64.mod_(d[10],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[15]=",",d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateRecoveryCodeStoredProcedure",[d[12],d[15],d[13],d[15],d[14]].join(""),d[16],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[1],c.i64.cast([0,0]),d[7]],e[0]=a[0],e[1]=a[1],e[2]=a[2],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsGenerateRecoveryCodeStoredProcedure";a.__tables__=["secure_encrypted_backups_generated_recovery_code","encrypted_backups"];e.exports=a}),null);
__d("LSGenerateRecoveryCodeStoredProcedure",["LSGenerateRecoveryCode","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSGenerateRecoveryCode"),e.virtualDeviceType);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MWEBPinCodeErrorsTypesEnum",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum").Mirrored(["EXTRA_DEVICE_CREATING_FAILED","GENERATE_RECOVERY_CODE_ERROR","REGISTER_VESTA_FAILED"]);c=a;f["default"]=c}),66);
__d("MWEncryptedBackupsCreateExtraVirtualDeviceDeferred",["FBLogger","I64","LSEncryptedBackupsCreateVirtualDeviceActionType","LSEncryptedBackupsOpStatus","LSEncryptedBackupsRecoveryCodeStatus","LSIntEnum","ReQL","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("requireDeferred")("MWEncryptedBackupsCreateExtraVirtualDevice").__setRef("MWEncryptedBackupsCreateExtraVirtualDeviceDeferred");function a(a){var b=a.actionType,e=b===void 0?c("LSEncryptedBackupsCreateVirtualDeviceActionType").INSERT:b,f=a.db,g=a.onFailure,k=a.onSuccess;j.onReady(function(a){c("promiseDone")(a.initializeCreateExtraVirtualDeviceStoredProcedure(f,(h||(h=d("I64"))).of_int32(e)),function(a){a=a[0];if(!(h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").SUCCESS)))return g();var b=f.tables.secure_encrypted_backups_recovery_code_status.subscribe(function(){c("promiseDone")(d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(f.tables.secure_encrypted_backups_recovery_code_status)),function(a){if(a==null)return;if(a.length!==1)return;a=a[0].recoveryCodeStatus;if((h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsRecoveryCodeStatus").VALID))){b();return k()}else if((h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsRecoveryCodeStatus").INVALID))){b();return g()}else return})})},function(){c("FBLogger")("labyrinth_web").mustfix("Error while creating extra virtual device.");return g()})})}g.encryptedBackupsCreateExtraVirtualDeviceDeferred=a}),98);
__d("MWEncryptedBackupsGenerateRecoveryCode",["Base64Utils","I64","LSFactory","LSGenerateRecoveryCodeStoredProcedure"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){var b=a.db,e=a.virtualDeviceType;return b.runInTransaction(function(a){return c("LSGenerateRecoveryCodeStoredProcedure")(c("LSFactory")(a),{virtualDeviceType:(h||(h=d("I64"))).of_int32(e)})},"readwrite",void 0,void 0,f.id+":31").then(function(a){var b=a[0],c=a[1];a=a[2];return{recoveryCode:b,sprocResult:c,virtualDeviceId:a!=null?d("Base64Utils").fromArrayBuffer(a):void 0}})}g.encryptedBackupsGenerateRecoveryCode=a}),98);
__d("VestaBackupSecretRegister",["Promise","asyncToGeneratorRuntime","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("E2EEBackupSecretRegisterModule").__setRef("VestaBackupSecretRegister"),j=c("requireDeferred")("VestaServerGraphQLRegisterProvider").__setRef("VestaBackupSecretRegister");function a(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.isAlreadyRegistered;c=c===void 0?!1:c;var d=a.environment;a=a.input;var e=(yield (h||(h=b("Promise"))).all([j.load(),i.load()])),f=e[0],g=f.beginRegister,k=f.finishRegister;f=f.initRegister;e=e[1];var l=e.registerBackupSecret;e=e.reRegisterBackupSecret;g=[{beginRegister:g,finishRegister:k,initRegister:f},a,{environment:d}];return c?e.apply(void 0,g):l.apply(void 0,g)});return k.apply(this,arguments)}g.vestaBackupSecretRegister=a}),98);
__d("MWEBPinCodeChange",["FBLogger","LSDataTraceCheckPoint","LSDataTraceType","LSEncryptedBackupsCreateVirtualDeviceActionType","LSIntEnum","MAWTraceUtils","MWEBPinCodeErrorsTypesEnum","MWEncryptedBackupsCreateExtraVirtualDeviceDeferred","MWEncryptedBackupsGenerateRecoveryCode","Promise","VestaBackupSecretRegister","asyncToGeneratorRuntime","gkx","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("requireDeferred")("VestaDeleteAccount").__setRef("MWEBPinCodeChange");function a(a){var e=a.db,f=a.environment,g=a.onFailedExtraDevice,k=a.onPinCodeError,l=a.onStart,m=a.onSuccess,n=a.pinCode,o=function(b,a,e){d("MAWTraceUtils").recordFailureAndFlushForTraceId(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_PIN_SETUP_FAILURE),[],b.message),k==null?void 0:k(e)},p=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var g=new TextEncoder();d("MAWTraceUtils").recordCheckpointForTrace(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").SAP_VESTA_CALLING_VESTA_REGISTRATION),[],!1);yield d("VestaBackupSecretRegister").vestaBackupSecretRegister({environment:f,input:{clientId:b,productUseCase:c("gkx")("24066")?"IGD_ENC_BACKUP":"MSGR_ENC_BACKUP",secret:g.encode(e),vestaAccountPin:n}});d("MAWTraceUtils").recordCheckpointForTrace(a,i.ofNumber(c("LSDataTraceCheckPoint").SAP_VESTA_REGISTRATION_COMPLETION),[],!1)});return function(b,c,d){return a.apply(this,arguments)}}(),q=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){d("MAWTraceUtils").recordCheckpointForTrace(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_PLUGIN_CALLING_CREATE_EXTRA_VIRTUAL_DEVICE),[],!1),yield new(h||(h=b("Promise")))(function(a,b){return d("MWEncryptedBackupsCreateExtraVirtualDeviceDeferred").encryptedBackupsCreateExtraVirtualDeviceDeferred({actionType:c("LSEncryptedBackupsCreateVirtualDeviceActionType").UNIQUE_VD_TYPE_INSERT,db:e,onFailure:b,onSuccess:a})}),d("MAWTraceUtils").recordSuccessAndFlushForTraceId(a,i.ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_PIN_SETUP_SUCCESS),[]),m()});return function(b){return a.apply(this,arguments)}}(),r=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,a,e){d("MAWTraceUtils").recordCheckpointForTrace(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_PIN_SETUP_FAILURE),[],!1,b.message);g==null?void 0:g();c("FBLogger")("labyrinth_web").catching(b).mustfix("[reset-pin] Error when creating extra virtual device with PIN");o(b,a,c("MWEBPinCodeErrorsTypesEnum").EXTRA_DEVICE_CREATING_FAILED);b=(yield j.load());a=b.vestaDeleteAccount;a({clientId:e,environment:f,productUseCase:"MSGR_ENC_BACKUP",updater:function(a){var b;b=(b=a.getRootField("fbid_based_auth_layer_vesta_delete_account"))==null?void 0:b.getLinkedRecord("vesta_user_info");if(b!=null){(a=a.getRoot())==null?void 0:(a=a.getLinkedRecord("viewer"))==null?void 0:(a=a.getLinkedRecord("messenger_default_encrypted_backup"))==null?void 0:(a=a.getLinkedRecord("vesta_user_info"))==null?void 0:a.copyFieldsFrom(b)}}})});return function(b,c,d){return a.apply(this,arguments)}}();l();var s=d("MAWTraceUtils").startNewTrace((i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").SAP_VESTA_REGISTRATION),d("MAWTraceUtils").CONTEXT_VESTA_REGISTRATION);d("MAWTraceUtils").recordCheckpointForTrace(s,i.ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_PLUGIN_CALLING_GENERATE_RECOVERY_CODE),[],!1);d("MWEncryptedBackupsGenerateRecoveryCode").encryptedBackupsGenerateRecoveryCode({db:e,virtualDeviceType:2}).then(function(a){var b=a.recoveryCode,d=a.virtualDeviceId;if(b==null||d==null)throw c("FBLogger")("labyrinth_web").mustfixThrow("Cannot change a PIN Code without a recovery code");p(s,d,b)["catch"](function(a){c("FBLogger")("labyrinth_web").mustfix("[reset-pin] Error when registering secret to backup",a.message),o(a,s,c("MWEBPinCodeErrorsTypesEnum").REGISTER_VESTA_FAILED)}).then(function(){return q(s)})["catch"](function(a){c("promiseDone")(r(a,s,d))})})["catch"](function(a){c("FBLogger")("labyrinth_web").mustfix("[reset-pin] Error when generating recovery code",a.message),o(a,s,c("MWEBPinCodeErrorsTypesEnum").GENERATE_RECOVERY_CODE_ERROR)})}g.mwEBPinCodeChange=a}),98);
__d("MWEncryptedBackupsHsmFleetMigration",["FBLogger","I64","LSIntEnum","MWChatEncryptedBackupsLogging","MWChatEncryptedBackupsQPLEvents","MWEBPinCodeChange","MWEBPinCodeErrorsTypesEnum","QPLUserFlow","ReQL","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a){return c("gkx")("24065")?!0:(a==null?void 0:a.requiresHsmMigration)===!0}function a(a){var b=a.db,e=a.environment,f=a.pinCode,g=a.startFlow;c("promiseDone")(d("ReQL").firstAsync(d("ReQL").fromTableAscending(b.tables.encrypted_backups_virtual_devices).filter(function(a){return(h||(h=d("I64"))).equal(a.virtualDeviceType,(i||(i=d("LSIntEnum"))).ofNumber(2))})).then(function(a){a&&j(a)&&d("MWEBPinCodeChange").mwEBPinCodeChange({db:b,environment:e,onFailedExtraDevice:function(){c("QPLUserFlow").markError(d("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent,"failed_extra_device_created")},onPinCodeError:function(a){switch(a){case c("MWEBPinCodeErrorsTypesEnum").EXTRA_DEVICE_CREATING_FAILED:d("MWChatEncryptedBackupsLogging").endFailure({errorName:"failed_create_extra_device",event:d("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent});break;case c("MWEBPinCodeErrorsTypesEnum").GENERATE_RECOVERY_CODE_ERROR:d("MWChatEncryptedBackupsLogging").endFailure({errorName:"generate_rc_error",event:d("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent});break;case c("MWEBPinCodeErrorsTypesEnum").REGISTER_VESTA_FAILED:d("MWChatEncryptedBackupsLogging").endFailure({errorName:"failed_register_vesta",event:d("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent});break}},onStart:function(){g({event:d("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent}),c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent,"hsm_migration_started")},onSuccess:function(){d("MWChatEncryptedBackupsLogging").endSuccess({event:d("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent})},pinCode:f})}),function(){},function(){c("FBLogger")("labyrinth_web").mustfix("[Encrypted Backups] HSM fleet migration - Failed to fetch virtual devices")})}g["default"]=a}),98);
__d("MWEncryptedBackupsHsmFleetMigrationGated",["cr:3373"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return b("cr:3373")==null?void 0:b("cr:3373")(a)}g["default"]=a}),98);